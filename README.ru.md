# PDF в изображения AWS Lambda

Бессерверная функция AWS Lambda, которая конвертирует PDF-файлы в изображения. Функция принимает загрузки PDF, конвертирует каждую страницу в изображение (JPEG по умолчанию) и сохраняет их в S3. Она включает веб-интерфейс для удобного тестирования и функции маршрутизации на основе путей, кэширования результатов и тегирования исходного IP-адреса.

## Возможности

- Конвертация PDF-файлов в отдельные изображения (JPEG по умолчанию)
- Маршрутизация API на основе путей для лучшей организации
- Кэширование результатов конвертации для повышения производительности
- Тегирование исходного IP-адреса загруженных изображений для отслеживания и аналитики
- Веб-интерфейс для тестирования
- Поддержка CORS для доступа из браузера
- Безопасные предварительно подписанные URL для прямых загрузок в S3
- Корректная обработка ошибок и логирование

## Архитектура

### Компоненты AWS
- **AWS Lambda**: Обрабатывает PDF и конвертирует изображения
- **Amazon S3**: Хранит загруженные PDF и конвертированные изображения
- **Lambda Function URL**: Предоставляет HTTP-конечную точку для функции

### Структура файлов
```
.
├── README.md
├── template.yaml             # SAM шаблон для ресурсов AWS
├── deps
│   ├── build_layer.sh       # Скрипт для создания Lambda слоя с Poppler
│   └── requirements.txt      # Зависимости Python
├── src
│   └── app.py               # Код функции Lambda
└── test_lambda.html         # Веб-интерфейс для тестирования
```

## API Endpoints

Функция Lambda предоставляет следующие конечные точки через свой Function URL:

1. **Получить URL для загрузки** (`GET /upload_url`)
   - Возвращает предварительно подписанный URL для загрузки PDF в S3. Клиент должен загрузить PDF по этому URL перед началом процесса конвертации.
   - Ответ: `{ "uploadUrl": "...", "fileId": "..." }`

2. **Обработать PDF** (`GET /process/<file-id>`)
   - Конвертирует загруженный PDF в изображения
   - Ответ: `{ "fileId": "...", "imageUrls": ["...", "..."], "pageCount": N }`
   - Исходный IP-адрес запроса автоматически тегируется к загруженным изображениям

## Обработка и кэширование изображений

Функция обрабатывает PDF-файлы и конвертирует их в изображения:
1. Каждая страница PDF конвертируется в изображение JPEG по умолчанию
2. Создаются две версии каждого изображения: основная (полный размер) и превью (миниатюра)
3. Результаты кэшируются для более быстрого получения при последующих запросах
4. Исходный IP-адрес запрашивающего тегируется к каждому загруженному изображению


## Настройка и развертывание

1. Установите необходимые компоненты:
   - AWS SAM CLI
   - Docker (для создания Lambda слоя)
   - Git (для клонирования репозитория)

2. Клонируйте этот репозиторий:
   ```bash
   git clone https://github.com/ai-1st/pdf-to-image-aws-lambda.git
   cd pdf-to-image-aws-lambda
   ```

3. Создайте Lambda слой (см. раздел [Создание Lambda слоя](#создание-lambda-слоя) для подробностей):
   ```bash
   cd deps
   chmod +x build_layer.sh
   ./build_layer.sh
   cd ..
   ```

4. Разверните с помощью SAM:
   ```bash
   sam build
   sam deploy --guided
   ```

## Создание Lambda слоя

Перед развертыванием необходимо создать Lambda слой, содержащий Poppler и другие зависимости. Слой создается с использованием Docker для обеспечения совместимости со средой Lambda.

### Предварительные требования
- Установлен и запущен Docker
- AWS SAM CLI
- Оболочка Bash

### Шаги сборки

1. Перейдите в директорию `deps`:
   ```bash
   cd deps
   ```

2. Сделайте скрипт сборки исполняемым:
   ```bash
   chmod +x build_layer.sh
   ```

3. Запустите скрипт сборки:
   ```bash
   ./build_layer.sh
   ```

Скрипт выполнит:
- Создание Docker-контейнера на основе образа AWS Lambda Python 3.13 ARM64
- Установку системных пакетов, включая Poppler и его зависимости
- Установку пакетов Python из requirements.txt
- Копирование необходимых бинарных файлов и общих библиотек
- Создание директории слоя с правильной структурой
- Очистку временных файлов

Результирующий слой будет создан в директории `deps/layer` со следующей структурой:
```
layer/
├── bin/          # Бинарные файлы Poppler (pdfinfo, pdftoppm, pdftocairo)
├── lib/          # Общие библиотеки
└── python/       # Пакеты Python
```

## Тестирование

1. Откройте `test_lambda.html` в веб-браузере
2. Введите ваш Lambda Function URL
3. Загрузите PDF-файл
4. Просмотрите конвертированные изображения в сетке

## Зависимости

- Python 3.8+
- pdf2image
- boto3
- Poppler (установлен в Lambda слое)

## Переменные окружения

- `BUCKET_NAME`: Имя S3-бакета для хранения файлов

## Безопасность

- CORS включен для доступа из браузера
- Предварительно подписанные URL для безопасных загрузок в S3
- Публичный Lambda Function URL с контролем CORS

## Обработка ошибок

Функция включает комплексную обработку ошибок для:
- Недопустимых типов файлов
- Неудачных конвертаций
- Проблем с загрузкой/скачиванием S3
- Проблем с CORS и предварительно подписанными URL

## Вклад в проект

Не стесняйтесь открывать issues или отправлять pull requests для улучшений.

## Лицензия

MIT License
